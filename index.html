<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>rekoriku</title>
    <link rel="stylesheet" href="./styles.css" />
  </head>
  <body>
    <main>
    <div class="panel">
      <div class="top">
        <div>
          <h1>Public repos</h1>
          <div class="muted">GitHub: <a href="https://github.com/rekoriku">rekoriku</a></div>
        </div>
        <div class="controls">
          <input id="q" type="search" placeholder="Search repos…" autocomplete="off" />
          <select id="sort">
            <option value="updated" selected>Sort: updated</option>
            <option value="stars">Sort: stars</option>
            <option value="name">Sort: name</option>
          </select>
          <label><input id="forks" type="checkbox" /> include forks</label>
        </div>
      </div>

      <div id="status" class="status muted">Loading…</div>
      <div id="list" class="list" aria-live="polite"></div>
    </div>
    </main>

    <script>
      const USER = 'rekoriku';
      const PER_PAGE = 100;

      const elQ = document.getElementById('q');
      const elSort = document.getElementById('sort');
      const elForks = document.getElementById('forks');
      const elStatus = document.getElementById('status');
      const elList = document.getElementById('list');

      let repos = [];
      let lastError = '';

      function fmtDate(iso) {
        try {
          return new Date(iso).toISOString().slice(0, 10);
        } catch {
          return '';
        }
      }

      function repoCard(r) {
        const stars = typeof r.stargazers_count === 'number' ? r.stargazers_count : 0;
        const forks = typeof r.forks_count === 'number' ? r.forks_count : 0;
        const lang = r.language || '';
        const updated = r.updated_at ? fmtDate(r.updated_at) : '';
        const desc = r.description || '';

        const meta = `
          <div class="meta-grid">
            ${lang ? `<span class="pill">${escapeHtml(lang)}</span>` : `<span class="pill placeholder">.</span>`}
            <span class="pill">★ ${stars}</span>
            <span class="pill">⑂ ${forks}</span>
            ${updated ? `<span class="pill">updated ${updated}</span>` : `<span class="pill placeholder">.</span>`}
            ${r.archived ? `<span class="pill">archived</span>` : `<span class="pill placeholder">.</span>`}
            ${r.fork ? `<span class="pill">fork</span>` : `<span class="pill placeholder">.</span>`}
          </div>
        `;

        return `
          <div class="repo">
            <h3><a href="${r.html_url}" target="_blank" rel="noreferrer">${escapeHtml(r.name)}</a></h3>
            ${desc ? `<p class="muted">${escapeHtml(desc)}</p>` : ''}
            ${meta}
          </div>
        `;
      }

      function escapeHtml(s) {
        return String(s)
          .replaceAll('&', '&amp;')
          .replaceAll('<', '&lt;')
          .replaceAll('>', '&gt;')
          .replaceAll('"', '&quot;')
          .replaceAll("'", '&#39;');
      }

      function applyFilterSort() {
        const q = (elQ.value || '').trim().toLowerCase();
        const includeForks = !!elForks.checked;
        const sort = elSort.value;

        let items = repos.slice();
        if (!includeForks) items = items.filter(r => !r.fork);

        if (q) {
          items = items.filter(r => {
            const hay = `${r.name || ''} ${r.description || ''} ${r.language || ''}`.toLowerCase();
            return hay.includes(q);
          });
        }

        items.sort((a, b) => {
          if (sort === 'stars') return (b.stargazers_count || 0) - (a.stargazers_count || 0);
          if (sort === 'name') return String(a.name || '').localeCompare(String(b.name || ''));
          return String(b.updated_at || '').localeCompare(String(a.updated_at || ''));
        });

        elList.innerHTML = items.map(repoCard).join('');

        const base = `${items.length} shown`;
        const err = lastError ? ` · ${lastError}` : '';
        elStatus.textContent = `${base} / ${repos.length} total${err}`;
      }

      async function fetchAllRepos() {
        let page = 1;
        const out = [];
        while (true) {
          const url = `https://api.github.com/users/${USER}/repos?per_page=${PER_PAGE}&page=${page}&type=public&sort=updated`;
          const res = await fetch(url, { headers: { 'Accept': 'application/vnd.github+json' } });
          if (!res.ok) {
            const txt = await res.text().catch(() => '');
            throw new Error(`GitHub API ${res.status}${txt ? `: ${txt}` : ''}`);
          }
          const batch = await res.json();
          if (!Array.isArray(batch) || batch.length === 0) break;
          out.push(...batch);
          if (batch.length < PER_PAGE) break;
          page += 1;
          if (page > 10) break;
        }
        return out;
      }

      async function init() {
        try {
          repos = await fetchAllRepos();
          lastError = '';
        } catch (e) {
          repos = [];
          lastError = (e && e.message) ? e.message : 'Failed to load repos';
        }
        applyFilterSort();
      }

      elQ.addEventListener('input', applyFilterSort);
      elSort.addEventListener('change', applyFilterSort);
      elForks.addEventListener('change', applyFilterSort);

      init();
    </script>
  </body>
</html>
